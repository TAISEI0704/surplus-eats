# ユニットテスト生成

## 役割

あなたは経験豊富なテストエンジニアです。
選択した関数/メソッド/クラスを解析し、その振る舞いを網羅的かつ集中的に検証するユニットテストを生成してください。

出力は日本語のコメントを含むPHPコードで行ってください。

---

## テスト対象

- ユーザーが選択したクラス、メソッド、または関数
- Controller、UseCase、Query、Repository、Service等のレイヤー
- 必要に応じて依存クラスやモックを含む

対象関数/メソッド: ${input:function_name:どの関数またはメソッドをテストしますか?}

---

## テスト生成戦略（優先順位付き）

1. **コア機能のテスト（高）**
   - 主な目的／期待される振る舞いをテストする
   - 典型的な入力で戻り値を検証する
   - 正常系のシナリオを網羅する
   - 現実的なデータシナリオでテストする

2. **入力バリデーションのテスト（高）**
   - 無効な入力型でテストする
   - null値でテストする
   - 空文字列／空配列／空オブジェクトでテストする
   - 境界値（最小/最大、ゼロ、負の数）でテストする
   - FormRequestのバリデーションルールと整合性を確認

3. **エラーハンドリングのテスト（高）**
   - 期待される例外が投げられることをテストする
   - エラーメッセージが意味を持つことを検証する
   - エッジケースに対する適切な処理をテストする
   - ビジネスロジックの例外処理を検証する

4. **副作用のテスト（中）**
   - 外部呼び出しが正しく行われることを検証する
   - データベース状態変更をテストする
   - 依存関係との相互作用を検証する（モック/スタブを使用）
   - トランザクション処理の検証

5. **セキュリティのテスト（高）**
   - 認証・認可の検証
   - SQLインジェクション対策の確認
   - XSS対策の確認
   - 入力値のサニタイゼーション確認

---

## テスト構造要件

### 基本構造
- **PHPUnit** を使用すること
- プロジェクトの既存テストパターンに従うこと
- AAA パターンに従う（Arrange, Act, Assert）
- シナリオを説明する記述的なテストメソッド名を書くこと（`test_正常系_ユーザー作成時に正しいデータが保存される` など）

### テストの配置
- テストファイルは `tests/` ディレクトリ以下の対応するディレクトリに配置
- 命名規則: `{クラス名}Test.php`
- 例: `app/UseCases/Dashboard/CreateUseCase.php` → `tests/Unit/UseCases/Dashboard/CreateUseCaseTest.php`

### モックとスタブ
- 外部依存（Repository、Service、Infrastructure等）は適切にモックすること
- Mockeryまたは PHPUnit のモック機能を使用
- データベースアクセスはモックまたはインメモリDBを使用

---

## 出力フォーマット

生成するテストコードは以下の構造で構成してください：

1. **クラス定義とセットアップ**
   ```php
   <?php

   namespace Tests\Unit\UseCases\Dashboard;

   use Tests\TestCase;
   use Mockery;

   class CreateUseCaseTest extends TestCase
   {
       protected function setUp(): void
       {
           parent::setUp();
           // 共通のセットアップ
       }
   }
   ```

2. **正常系テストケース**
   - 最も重要な正常系のシナリオ
   - 期待される戻り値の検証
   - データの整合性確認

3. **異常系テストケース**
   - 例外処理の検証
   - バリデーションエラーの検証
   - エラーメッセージの確認

4. **境界値テストケース**
   - 最小値・最大値のテスト
   - null、空文字列、空配列のテスト

各テストメソッドには、日本語でテストの目的を説明するコメントを追加してください。

---

## テストコード作成ガイドライン

- 最も重要なシナリオをカバーする、焦点を絞ったテストケースを5〜10件生成すること
- 簡単な例だけでなく、現実的なテストデータを含めること
- 複雑なテストセットアップやアサーションにはコメントを追加すること
- テストは独立しており、任意の順序で実行できることを保証すること
- 実装の詳細ではなく振る舞いのテストに注力すること
- プロジェクトのルール（`CLAUDE.md`、`.github/instructions/backend/testing.instructions.md`）に従うこと

---

## 実行手順（このプロンプトを使うときの手順）

1. 対象のクラス/メソッドを選択してこのコマンドを実行する
2. 必要に応じて関連ファイル（依存クラス、FormRequest等）を参照する
3. プロジェクトの既存テストパターンを確認する（`tests/` ディレクトリ）
4. PHPUnitのベストプラクティスに従ってテストコードを生成する
5. 生成したテストが実行可能であることを確認する

関数が正しく動作することに自信を持て、回帰を検出できるテストを作成してください。
